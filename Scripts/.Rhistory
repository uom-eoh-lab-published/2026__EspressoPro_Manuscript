test_cells  <- character()
for (lbl in lvls) {
cells_lbl <- colnames(Hao.SCObject)[labels == lbl]
if (!length(cells_lbl)) next
obj_sub <- subset(Hao.SCObject, cells = cells_lbl)
obj_sub <- NormalizeData(obj_sub,
normalization.method = "CLR",
margin = 2,
assay = 'ADT',
verbose = T
)
obj_sub <- FindVariableFeatures(obj_sub, assay = 'ADT')
obj_sub <- SketchData(
object   = obj_sub,
group.by = NULL,                                  # sketch *within* this label only
features = rownames(obj_sub[["ADT"]]@data),
assay    = "ADT",
n        = max(1, round(ncol(obj_sub) * prop_train)),
seed     = 123,
verbose  = TRUE
)
train_lbl <- colnames(obj_sub[["sketch"]]@data)     # sketched cells = train
test_lbl  <- setdiff(cells_lbl, train_lbl)          # remainder = test
train_cells <- c(train_cells, train_lbl)
test_cells  <- c(test_cells,  test_lbl)
}
# 2) Build Train/Test objects -----------------------------------------
Hao.SCObject_Train <- subset(Hao.SCObject, cells = train_cells)
Hao.SCObject_Test  <- subset(Hao.SCObject, cells = test_cells)
# Drop the temporary 'sketch' assay in Train (optional)
if ("sketch" %in% Assays(Hao.SCObject_Train)) {
Hao.SCObject_Train[["sketch"]] <- NULL
}
# 3) Sanity checks -----------------------------------------------------
stopifnot(length(intersect(colnames(Hao.SCObject_Train),
colnames(Hao.SCObject_Test))) == 0)
stopifnot(setequal(
c(colnames(Hao.SCObject_Train), colnames(Hao.SCObject_Test)),
colnames(Hao.SCObject)
))
# 4) (Optional) Quick peek --------------------------------------------
table(Hao.SCObject_Train$Consensus_annotation_detailed_final)
table(Hao.SCObject_Test$Consensus_annotation_detailed_final)
DimPlot(Hao.SCObject_Train, group.by = 'Consensus_annotation_detailed_final', reduction = 'wnn.umap', label = T) + DimPlot(Hao.SCObject_Test, group.by = 'Consensus_annotation_detailed_final', reduction = 'wnn.umap', label = T)
Hao.SCObject_Train <- NormalizeData(Hao.SCObject_Train,
normalization.method = "CLR",
margin = 2,
assay = 'ADT',
verbose = T
)
Hao.SCObject_Test <- NormalizeData(Hao.SCObject_Test,
normalization.method = "CLR",
margin = 2,
assay = 'ADT',
verbose = T
)
Hao.SCObject_Train.AvgExpMat <- AverageExpression(Hao.SCObject_Train, group.by = 'Consensus_annotation_detailed_final')
Hao.SCObject_Test.AvgExpMat <- AverageExpression(Hao.SCObject_Test, group.by = 'Consensus_annotation_detailed_final')
train_mat <- as.matrix(Hao.SCObject_Train.AvgExpMat$ADT)
test_mat  <- as.matrix(Hao.SCObject_Test.AvgExpMat$ADT)
storage.mode(train_mat) <- "numeric"
storage.mode(test_mat)  <- "numeric"
ComplexHeatmap::Heatmap(cor(train_mat, test_mat), cluster_rows = F, cluster_columns = F)
sceasy::convertFormat(obj = Hao.SCObject_Train, outFile = paste0(local_wd_folder, '/Data/References/Hao/228AB_healthy_donors_PBMNCs_annotated_Train.h5ad'),
from="seurat", to="anndata", assay = 'ADT', main_layer = 'counts')
sceasy::convertFormat(obj = Hao.SCObject_Test, outFile = paste0(local_wd_folder, '/Data/References/Hao/228AB_healthy_donors_PBMNCs_annotated_BMMNCs_annotated_Test.h5ad'),
from="seurat", to="anndata", assay = 'ADT', main_layer = 'counts')
labels <- Hao.SCObject_Train[[label_col]][,1]
labels[is.na(labels)] <- "NA"                         # handle NAs explicitly
lvls   <- sort(unique(labels))
for (lbl in lvls) {
n_cells  <- sum(labels == lbl)                              # target size
rest_ids <- colnames(Hao.SCObject_Train)[labels != lbl]   # the “rest”
if (!length(rest_ids)) next
obj_rest <- subset(Hao.SCObject_Train, cells = rest_ids)
# ADT normalization
obj_rest <- NormalizeData(
obj_rest,
normalization.method = "CLR",
margin = 2,
assay = "ADT",
verbose = TRUE
)
obj_rest <- FindVariableFeatures(obj_rest, assay = 'ADT')
obj_rest <- SketchData(
object   = obj_rest,
group.by = NULL,                 # sketch across the rest
features = obj_rest@assays$ADT@var.features,
assay    = "ADT",
n        = max(1, round(n_cells)),
seed     = 123,
verbose  = TRUE
)
# cells from current label vs. downsampled rest
one_lbl  <- colnames(Hao.SCObject_Train)[labels == lbl]
rest_lbl <- colnames(obj_rest[["sketch"]]@data)  # cells kept by sketch
Hao.SCObject_One  <- subset(Hao.SCObject_Train, cells = one_lbl)
Hao.SCObject_Rest <- subset(Hao.SCObject_Train, cells = rest_lbl)
print(
DimPlot(Hao.SCObject_One,  group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE) +
DimPlot(Hao.SCObject_Rest, group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE))
df <- data.frame(row.names = 1:length(colnames(Hao.SCObject_One)))
df$Positive <- colnames(Hao.SCObject_One)
df$Negative <- colnames(Hao.SCObject_Rest)
write.csv(df, file = paste0(Training_barcodes_data_folder, '/Hao/Barcodes_training_class_', lbl, '.csv'))
}
Triana.SCObject <- sceasy::convertFormat(obj = paste0(local_wd_folder, '/Data/References/Triana/97AB_young_and_old_adult_healthy_donor_BMMNCs_annotated.h5ad'),
from="anndata", to="seurat", assay = 'AB', main_layer = 'counts')
Triana.SCObject <- subset(Triana.SCObject, cells = WhichCells(Triana.SCObject, expression = Consensus_annotation_detailed_final %in% names(table(Triana.SCObject$Consensus_annotation_detailed_final))[grep(FALSE, table(Triana.SCObject$Consensus_annotation_detailed_final) < 50)]))
# 0) Prep -------------------------------------------------------------
DefaultAssay(Triana.SCObject) <- "AB"
prop_train <- 0.80
label_col  <- "Consensus_annotation_detailed_final"
# (Optional) ensure the label exists
stopifnot(label_col %in% colnames(Triana.SCObject@meta.data))
# 1) Stratified sketch per label --------------------------------------
labels <- Triana.SCObject[[label_col]][,1]
labels[is.na(labels)] <- "NA"                         # handle NAs explicitly
lvls   <- sort(unique(labels))
train_cells <- character()
test_cells  <- character()
for (lbl in lvls) {
cells_lbl <- colnames(Triana.SCObject)[labels == lbl]
if (!length(cells_lbl)) next
obj_sub <- subset(Triana.SCObject, cells = cells_lbl)
obj_sub <- NormalizeData(obj_sub,
normalization.method = "CLR",
margin = 2,
assay = 'AB',
verbose = T
)
obj_sub <- FindVariableFeatures(obj_sub, assay = 'AB')
obj_sub <- SketchData(
object   = obj_sub,
group.by = NULL,                                  # sketch *within* this label only
features = rownames(obj_sub[["AB"]]@data),
assay    = "AB",
n        = max(1, round(ncol(obj_sub) * prop_train)),
seed     = 123,
verbose  = TRUE
)
train_lbl <- colnames(obj_sub[["sketch"]]@data)     # sketched cells = train
test_lbl  <- setdiff(cells_lbl, train_lbl)          # remainder = test
train_cells <- c(train_cells, train_lbl)
test_cells  <- c(test_cells,  test_lbl)
}
# 2) Build Train/Test objects -----------------------------------------
Triana.SCObject_Train <- subset(Triana.SCObject, cells = train_cells)
Triana.SCObject_Test  <- subset(Triana.SCObject, cells = test_cells)
# Drop the temporary 'sketch' assay in Train (optional)
if ("sketch" %in% Assays(Triana.SCObject_Train)) {
Triana.SCObject_Train[["sketch"]] <- NULL
}
# 3) Sanity checks -----------------------------------------------------
stopifnot(length(intersect(colnames(Triana.SCObject_Train),
colnames(Triana.SCObject_Test))) == 0)
stopifnot(setequal(
c(colnames(Triana.SCObject_Train), colnames(Triana.SCObject_Test)),
colnames(Triana.SCObject)
))
# 4) (Optional) Quick peek --------------------------------------------
table(Triana.SCObject_Train$Consensus_annotation_detailed_final)
table(Triana.SCObject_Test$Consensus_annotation_detailed_final)
DimPlot(Triana.SCObject_Train, group.by = 'Consensus_annotation_detailed_final', reduction = 'mofaumap', label = T) + DimPlot(Triana.SCObject_Test, group.by = 'Consensus_annotation_detailed_final', reduction = 'mofaumap', label = T)
Triana.SCObject_Train <- NormalizeData(Triana.SCObject_Train,
normalization.method = "CLR",
margin = 2,
assay = 'AB',
verbose = T
)
Triana.SCObject_Test <- NormalizeData(Triana.SCObject_Test,
normalization.method = "CLR",
margin = 2,
assay = 'AB',
verbose = T
)
Triana.SCObject_Train.AvgExpMat <- AverageExpression(Triana.SCObject_Train, group.by = 'Consensus_annotation_detailed_final')
Triana.SCObject_Test.AvgExpMat <- AverageExpression(Triana.SCObject_Test, group.by = 'Consensus_annotation_detailed_final')
train_mat <- as.matrix(Triana.SCObject_Train.AvgExpMat$AB)
test_mat  <- as.matrix(Triana.SCObject_Test.AvgExpMat$AB)
storage.mode(train_mat) <- "numeric"
storage.mode(test_mat)  <- "numeric"
ComplexHeatmap::Heatmap(cor(train_mat, test_mat), cluster_rows = F, cluster_columns = F)
sceasy::convertFormat(obj = Triana.SCObject_Train, outFile = paste0(local_wd_folder, '/Data/References/Triana/97AB_young_and_old_adult_healthy_donor_BMMNCs_annotated_Train.h5ad'),
from="seurat", to="anndata", assay = 'AB', main_layer = 'counts')
sceasy::convertFormat(obj = Triana.SCObject_Test, outFile = paste0(local_wd_folder, '/Data/References/Triana/97AB_young_and_old_adult_healthy_donor_BMMNCs_annotated_Test.h5ad'),
from="seurat", to="anndata", assay = 'AB', main_layer = 'counts')
labels <- Triana.SCObject_Train[[label_col]][,1]
labels[is.na(labels)] <- "NA"                         # handle NAs explicitly
lvls   <- sort(unique(labels))
for (lbl in lvls) {
n_cells  <- sum(labels == lbl)                              # target size
rest_ids <- colnames(Triana.SCObject_Train)[labels != lbl]   # the “rest”
if (!length(rest_ids)) next
obj_rest <- subset(Triana.SCObject_Train, cells = rest_ids)
# ADT normalization
obj_rest <- NormalizeData(
obj_rest,
normalization.method = "CLR",
margin = 2,
assay = "AB",
verbose = TRUE
)
obj_rest <- FindVariableFeatures(obj_rest, assay = 'AB')
obj_rest <- SketchData(
object   = obj_rest,
group.by = NULL,                 # sketch across the rest
features = obj_rest@assays$AB@var.features,
assay    = "AB",
n        = max(1, round(n_cells)),
seed     = 123,
verbose  = TRUE
)
# cells from current label vs. downsampled rest
one_lbl  <- colnames(Triana.SCObject_Train)[labels == lbl]
rest_lbl <- colnames(obj_rest[["sketch"]]@data)  # cells kept by sketch
Triana.SCObject_One  <- subset(Triana.SCObject_Train, cells = one_lbl)
Triana.SCObject_Rest <- subset(Triana.SCObject_Train, cells = rest_lbl)
print(
DimPlot(Triana.SCObject_One,  group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE) +
DimPlot(Triana.SCObject_Rest, group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE))
df <- data.frame(row.names = 1:length(colnames(Triana.SCObject_One)))
df$Positive <- colnames(Triana.SCObject_One)
df$Negative <- colnames(Triana.SCObject_Rest)
write.csv(df, file = paste0(Training_barcodes_data_folder, '/Triana/Barcodes_training_class_', lbl, '.csv'))
}
Luecken.SCObject <- sceasy::convertFormat(obj = paste0(local_wd_folder, '/Data/References/Luecken/140AB_adult_healthy_donor_BMMNCs_annotated.h5ad'),
from="anndata", to="seurat", assay = 'ADT', main_layer = 'counts')
Luecken.SCObject <- subset(Luecken.SCObject, cells = WhichCells(Luecken.SCObject, expression = Consensus_annotation_detailed_final %in% names(table(Luecken.SCObject$Consensus_annotation_detailed_final))[grep(FALSE, table(Luecken.SCObject$Consensus_annotation_detailed_final) < 50)]))
# 0) Prep -------------------------------------------------------------
DefaultAssay(Luecken.SCObject) <- "ADT"
prop_train <- 0.80
label_col  <- "Consensus_annotation_detailed_final"
# (Optional) ensure the label exists
stopifnot(label_col %in% colnames(Luecken.SCObject@meta.data))
# 1) Stratified sketch per label --------------------------------------
labels <- Luecken.SCObject[[label_col]][,1]
labels[is.na(labels)] <- "NA"                         # handle NAs explicitly
lvls   <- sort(unique(labels))
train_cells <- character()
test_cells  <- character()
for (lbl in lvls) {
cells_lbl <- colnames(Luecken.SCObject)[labels == lbl]
if (!length(cells_lbl)) next
obj_sub <- subset(Luecken.SCObject, cells = cells_lbl)
obj_sub <- NormalizeData(obj_sub,
normalization.method = "CLR",
margin = 2,
assay = 'ADT',
verbose = T
)
obj_sub <- FindVariableFeatures(obj_sub, assay = 'ADT')
obj_sub <- SketchData(
object   = obj_sub,
group.by = NULL,                                  # sketch *within* this label only
features = rownames(obj_sub[["ADT"]]@data),
assay    = "ADT",
n        = max(1, round(ncol(obj_sub) * prop_train)),
seed     = 123,
verbose  = TRUE
)
train_lbl <- colnames(obj_sub[["sketch"]]@data)     # sketched cells = train
test_lbl  <- setdiff(cells_lbl, train_lbl)          # remainder = test
train_cells <- c(train_cells, train_lbl)
test_cells  <- c(test_cells,  test_lbl)
}
# 2) Build Train/Test objects -----------------------------------------
Luecken.SCObject_Train <- subset(Luecken.SCObject, cells = train_cells)
Luecken.SCObject_Test  <- subset(Luecken.SCObject, cells = test_cells)
# Drop the temporary 'sketch' assay in Train (optional)
if ("sketch" %in% Assays(Luecken.SCObject_Train)) {
Luecken.SCObject_Train[["sketch"]] <- NULL
}
# 3) Sanity checks -----------------------------------------------------
stopifnot(length(intersect(colnames(Luecken.SCObject_Train),
colnames(Luecken.SCObject_Test))) == 0)
stopifnot(setequal(
c(colnames(Luecken.SCObject_Train), colnames(Luecken.SCObject_Test)),
colnames(Luecken.SCObject)
))
# 4) (Optional) Quick peek --------------------------------------------
table(Luecken.SCObject_Train$Consensus_annotation_detailed_final)
table(Luecken.SCObject_Test$Consensus_annotation_detailed_final)
DimPlot(Luecken.SCObject_Train, group.by = 'Consensus_annotation_detailed_final', reduction = 'umap', label = T) + DimPlot(Luecken.SCObject_Test, group.by = 'Consensus_annotation_detailed_final', reduction = 'umap', label = T)
Luecken.SCObject_Train <- NormalizeData(Luecken.SCObject_Train,
normalization.method = "CLR",
margin = 2,
assay = 'ADT',
verbose = T
)
Luecken.SCObject_Test <- NormalizeData(Luecken.SCObject_Test,
normalization.method = "CLR",
margin = 2,
assay = 'ADT',
verbose = T
)
Luecken.SCObject_Train.AvgExpMat <- AverageExpression(Luecken.SCObject_Train, group.by = 'Consensus_annotation_detailed_final')
Luecken.SCObject_Test.AvgExpMat <- AverageExpression(Luecken.SCObject_Test, group.by = 'Consensus_annotation_detailed_final')
train_mat <- as.matrix(Luecken.SCObject_Train.AvgExpMat$ADT)
test_mat  <- as.matrix(Luecken.SCObject_Test.AvgExpMat$ADT)
storage.mode(train_mat) <- "numeric"
storage.mode(test_mat)  <- "numeric"
ComplexHeatmap::Heatmap(cor(train_mat, test_mat), cluster_rows = F, cluster_columns = F)
sceasy::convertFormat(obj = Luecken.SCObject_Train, outFile = paste0(local_wd_folder, '/Data/References/Luecken/140AB_adult_healthy_donor_BMMNCs_annotated_Train.h5ad'),
from="seurat", to="anndata", assay = 'ADT', main_layer = 'counts')
sceasy::convertFormat(obj = Luecken.SCObject_Test, outFile = paste0(local_wd_folder, '/Data/References/Luecken/140AB_adult_healthy_donor_BMMNCs_annotated_Test.h5ad'),
from="seurat", to="anndata", assay = 'ADT', main_layer = 'counts')
labels <- Luecken.SCObject_Train[[label_col]][,1]
labels[is.na(labels)] <- "NA"                         # handle NAs explicitly
lvls   <- sort(unique(labels))
for (lbl in lvls) {
n_cells  <- sum(labels == lbl)                              # target size
rest_ids <- colnames(Luecken.SCObject_Train)[labels != lbl]   # the “rest”
if (!length(rest_ids)) next
obj_rest <- subset(Luecken.SCObject_Train, cells = rest_ids)
# ADT normalization
obj_rest <- NormalizeData(
obj_rest,
normalization.method = "CLR",
margin = 2,
assay = "ADT",
verbose = TRUE
)
obj_rest <- FindVariableFeatures(obj_rest, assay = 'ADT')
obj_rest <- SketchData(
object   = obj_rest,
group.by = NULL,                 # sketch across the rest
features = obj_rest@assays$ADT@var.features,
assay    = "ADT",
n        = max(1, round(n_cells)),
seed     = 123,
verbose  = TRUE
)
# cells from current label vs. downsampled rest
one_lbl  <- colnames(Luecken.SCObject_Train)[labels == lbl]
rest_lbl <- colnames(obj_rest[["sketch"]]@data)  # cells kept by sketch
Luecken.SCObject_One  <- subset(Luecken.SCObject_Train, cells = one_lbl)
Luecken.SCObject_Rest <- subset(Luecken.SCObject_Train, cells = rest_lbl)
print(
DimPlot(Luecken.SCObject_One,  group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE) +
DimPlot(Luecken.SCObject_Rest, group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE))
df <- data.frame(row.names = 1:length(colnames(Luecken.SCObject_One)))
df$Positive <- colnames(Luecken.SCObject_One)
df$Negative <- colnames(Luecken.SCObject_Rest)
write.csv(df, file = paste0(Training_barcodes_data_folder, '/Luecken/Barcodes_training_class_', lbl, '.csv'))
}
label_cols  <- c("Consensus_annotation_broad_final",
"Consensus_annotation_simplified_final",
"Consensus_annotation_detailed_final")
for (label_col in label_cols) {
labels <- Zhang.SCObject_Train[[label_col]][,1]
labels[is.na(labels)] <- "NA"                         # handle NAs explicitly
lvls   <- sort(unique(labels))
for (lbl in lvls) {
n_cells  <- sum(labels == lbl)                              # target size
rest_ids <- colnames(Zhang.SCObject_Train)[labels != lbl]   # the “rest”
if (!length(rest_ids)) next
obj_rest <- subset(Zhang.SCObject_Train, cells = rest_ids)
# ADT normalization
obj_rest <- NormalizeData(
obj_rest,
normalization.method = "CLR",
margin = 2,
assay = "ADT",
verbose = TRUE
)
obj_rest <- FindVariableFeatures(obj_rest, assay = 'ADT')
obj_rest <- SketchData(
object   = obj_rest,
group.by = NULL,                 # sketch across the rest
features = obj_rest@assays$ADT@var.features,
assay    = "ADT",
n        = max(1, round(n_cells)),
seed     = 123,
verbose  = TRUE
)
# cells from current label vs. downsampled rest
one_lbl  <- colnames(Zhang.SCObject_Train)[labels == lbl]
rest_lbl <- colnames(obj_rest[["sketch"]]@data)  # cells kept by sketch
Zhang.SCObject_One  <- subset(Zhang.SCObject_Train, cells = one_lbl)
Zhang.SCObject_Rest <- subset(Zhang.SCObject_Train, cells = rest_lbl)
print(
DimPlot(Zhang.SCObject_One,  group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE) +
DimPlot(Zhang.SCObject_Rest, group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE))
df <- data.frame(row.names = 1:length(colnames(Zhang.SCObject_One)))
df$Positive <- colnames(Zhang.SCObject_One)
df$Negative <- colnames(Zhang.SCObject_Rest)
dir.create(paste0(Training_barcodes_data_folder, '/Zhang/', label_col))
write.csv(df, file = paste0(Training_barcodes_data_folder, '/Zhang/', label_col, '/Barcodes_training_class_', lbl, '.csv'))
}
}
label_cols
label_cols  <- c("Consensus_annotation_broad_final",
"Consensus_annotation_simplified_final",
"Consensus_annotation_detailed_final")
for (label_col in label_cols) {
labels <- Zhang.SCObject_Train[[label_col]][,1]
labels[is.na(labels)] <- "NA"
lvls <- sort(unique(labels))
for (lbl in lvls) {
n_pos   <- sum(labels == lbl)
rest_ids <- colnames(Zhang.SCObject_Train)[labels != lbl]
if (!length(rest_ids)) next
obj_rest <- subset(Zhang.SCObject_Train, cells = rest_ids)
# ADT normalization
obj_rest <- NormalizeData(
obj_rest, normalization.method = "CLR",
margin = 2, assay = "ADT", verbose = TRUE
)
# Choose ADT features (use all proteins to be safe for ADT)
VariableFeatures(obj_rest, assay = "ADT") <- rownames(obj_rest[["ADT"]])
feats <- VariableFeatures(obj_rest, assay = "ADT")
obj_rest <- SketchData(
object   = obj_rest,
group.by = NULL,
features = feats,      # or set to NULL if your SketchData handles it
assay    = "ADT",
n        = max(1, round(n_pos)),
seed     = 123,
verbose  = TRUE
)
# Current label vs downsampled rest
one_ids  <- colnames(Zhang.SCObject_Train)[labels == lbl]
rest_lbl <- colnames(obj_rest)  # after sketch this is the sampled set
Zhang.SCObject_One  <- subset(Zhang.SCObject_Train, cells = one_ids)
Zhang.SCObject_Rest <- subset(Zhang.SCObject_Train, cells = rest_lbl)
print(
DimPlot(Zhang.SCObject_One,  group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE) +
DimPlot(Zhang.SCObject_Rest, group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE)
)
# --- Write paired barcodes safely --------------------------------------
# Pad/truncate to equal length to avoid data.frame length errors
L <- max(length(one_ids), length(rest_lbl))
length(one_ids)  <- L
length(rest_lbl) <- L
df <- data.frame(
Positive = one_ids,
Negative = rest_lbl,
stringsAsFactors = FALSE
)
out_dir <- file.path(Training_barcodes_data_folder, "Zhang", label_col)
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
safe_lbl <- gsub("[^A-Za-z0-9_.-]+", "_", lbl)
out_csv  <- file.path(out_dir, paste0("Barcodes_training_class_", safe_lbl, ".csv"))
write.csv(df, file = out_csv, row.names = FALSE)
}
}
label_cols  <- c("Consensus_annotation_broad_final",
"Consensus_annotation_simplified_final",
"Consensus_annotation_detailed_final")
for (label_col in label_cols) {
labels <- Zhang.SCObject_Train[[label_col]][,1]
labels[is.na(labels)] <- "NA"
lvls <- sort(unique(labels))
for (lbl in lvls) {
n_pos   <- sum(labels == lbl)
rest_ids <- colnames(Zhang.SCObject_Train)[labels != lbl]
if (!length(rest_ids)) next
obj_rest <- subset(Zhang.SCObject_Train, cells = rest_ids)
# ADT normalization
obj_rest <- NormalizeData(
obj_rest, normalization.method = "CLR",
margin = 2, assay = "ADT", verbose = TRUE
)
obj_rest <- FindVariableFeatures(obj_rest, assay = "ADT")
obj_rest <- SketchData(
object   = obj_rest,
group.by = NULL,
features = obj_rest@assays$ADT@var.features,      # or set to NULL if your SketchData handles it
assay    = "ADT",
n        = max(1, round(n_pos)),
seed     = 123,
verbose  = TRUE
)
# Current label vs downsampled rest
one_ids  <- colnames(Zhang.SCObject_Train)[labels == lbl]
rest_lbl <- colnames(obj_rest)  # after sketch this is the sampled set
Zhang.SCObject_One  <- subset(Zhang.SCObject_Train, cells = one_ids)
Zhang.SCObject_Rest <- subset(Zhang.SCObject_Train, cells = rest_lbl)
print(
DimPlot(Zhang.SCObject_One,  group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE) +
DimPlot(Zhang.SCObject_Rest, group.by = "Consensus_annotation_detailed_final",
reduction = "umap", label = TRUE)
)
# --- Write paired barcodes safely --------------------------------------
# Pad/truncate to equal length to avoid data.frame length errors
L <- max(length(one_ids), length(rest_lbl))
length(one_ids)  <- L
length(rest_lbl) <- L
df <- data.frame(
Positive = one_ids,
Negative = rest_lbl,
stringsAsFactors = FALSE
)
out_dir <- file.path(Training_barcodes_data_folder, "Zhang", label_col)
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
safe_lbl <- gsub("[^A-Za-z0-9_.-]+", "_", lbl)
out_csv  <- file.path(out_dir, paste0("Barcodes_training_class_", safe_lbl, ".csv"))
write.csv(df, file = out_csv, row.names = FALSE)
}
}
